<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viral Video Creator Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        .step-active { color: #3b82f6; }
        .step-circle-active { background-color: #3b82f6; border-color: #3b82f6; color: white; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        canvas { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen selection:bg-blue-500 selection:text-white">

    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-900/90 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-2 rounded-lg">
                    <i data-lucide="video" class="w-5 h-5 text-white"></i>
                </div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">ViralVideo Pro</h1>
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-gray-800 rounded-full transition-colors">
                <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 md:p-8">

        <!-- Settings Modal/Section -->
        <div id="settings-panel" class="hidden mb-6 bg-gray-800 rounded-xl p-6 border border-gray-700 fade-in">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="key" class="w-5 h-5"></i> API Configuration</h2>
            <p class="text-gray-400 mb-4 text-sm">Enter your Google Gemini API Keys. You can use the same key for all fields.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Main API Key (Required)</label>
                    <input type="password" id="api-key-main" placeholder="Paste Gemini API Key here" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-3 text-white focus:border-blue-500 outline-none">
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image API Key (Optional)</label>
                        <input type="password" id="api-key-image" placeholder="Leave empty to use Main Key" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-3 text-white focus:border-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Voice API Key (Optional)</label>
                        <input type="password" id="api-key-voice" placeholder="Leave empty to use Main Key" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-2 px-3 text-white focus:border-blue-500 outline-none text-sm">
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">Save & Close</button>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="flex justify-between items-center mb-8 px-4" id="step-indicator">
            <!-- Injected via JS -->
        </div>

        <!-- Step 1: Input -->
        <div id="step-1" class="fade-in">
            <div class="bg-gray-800 rounded-xl p-8 text-center border border-gray-700 shadow-xl">
                <div class="mx-auto bg-gray-700/50 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="wand-2" class="w-8 h-8 text-blue-400"></i>
                </div>
                <h2 class="text-2xl font-bold mb-6">Create Viral Video</h2>
                
                <div class="max-w-xl mx-auto space-y-6 text-left">
                    <!-- Topic -->
                    <div>
                        <label class="text-xs text-gray-400 font-bold ml-1 mb-1 block uppercase tracking-wide">Video Topic</label>
                        <input type="text" id="topic-input" placeholder="e.g. Scariest Places, Future of AI, Motivation..." class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-blue-500 outline-none text-lg">
                    </div>

                    <!-- Aspect Ratio -->
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="setAspectRatio('9:16')" id="ratio-9-16" class="cursor-pointer p-4 rounded-xl border-2 border-blue-500 bg-blue-500/10 transition-all flex flex-col items-center gap-2 hover:bg-gray-700">
                            <i data-lucide="smartphone" class="w-6 h-6 text-blue-400"></i>
                            <span class="text-sm font-bold">Shorts (9:16)</span>
                        </div>
                        <div onclick="setAspectRatio('16:9')" id="ratio-16-9" class="cursor-pointer p-4 rounded-xl border-2 border-gray-700 bg-gray-800 transition-all flex flex-col items-center gap-2 hover:border-gray-500">
                            <i data-lucide="monitor" class="w-6 h-6 text-gray-400"></i>
                            <span class="text-sm font-bold">Video (16:9)</span>
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Duration</label>
                            <select id="duration-select" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm outline-none focus:border-blue-500">
                                <option value="15">15 Seconds</option>
                                <option value="30">30 Seconds</option>
                                <option value="60" selected>60 Seconds</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Language</label>
                            <select id="language-select" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm outline-none focus:border-blue-500">
                                <option value="English">English</option>
                                <option value="Hindi">Hindi</option>
                                <option value="Urdu">Urdu</option>
                                <option value="Spanish">Spanish</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Voice</label>
                            <select id="voice-select" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm outline-none focus:border-blue-500">
                                <option value="Aoede">Female (Soft)</option>
                                <option value="Kore">Female (Energetic)</option>
                                <option value="Fenrir">Male (Deep)</option>
                                <option value="Charon">Male (Narrator)</option>
                                <option value="Puck">Male (Casual)</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="generateTitles()" id="btn-gen-titles" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg flex justify-center gap-2 items-center mt-4 transition-all hover:scale-[1.02] shadow-lg shadow-blue-900/50">
                        <i data-lucide="sparkles" class="w-5 h-5"></i> Generate Titles
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Titles -->
        <div id="step-2" class="hidden fade-in">
            <h2 class="text-xl font-bold mb-4">Select a Title</h2>
            <div id="titles-container" class="grid gap-3">
                <!-- Titles injected here -->
            </div>
            <button onclick="setStep(1)" class="mt-4 text-gray-400 hover:text-white text-sm">← Back</button>
        </div>

        <!-- Step 3: Script -->
        <div id="step-3" class="hidden fade-in">
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-xl font-bold">Script Preview</h2>
                        <div class="flex items-center gap-2 text-xs text-gray-400 mt-1">
                            <span class="bg-gray-700 px-2 py-0.5 rounded text-gray-200" id="preview-ratio"></span>
                            <span class="bg-gray-700 px-2 py-0.5 rounded text-gray-200" id="preview-scenes"></span>
                        </div>
                    </div>
                    <button onclick="generateAssets()" id="btn-gen-assets" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-green-900/50 transition-all hover:scale-105">
                        <i data-lucide="zap" class="w-4 h-4 fill-current text-yellow-300"></i> Generate Video
                    </button>
                </div>

                <div id="script-container" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Script items injected here -->
                </div>
            </div>
            <button onclick="setStep(2)" class="mt-4 text-gray-400 hover:text-white text-sm">← Back</button>
        </div>

        <!-- Step 4: Render / Result -->
        <div id="step-4" class="hidden fade-in">
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Timeline List -->
                <div class="md:col-span-1 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar" id="timeline-container">
                    <!-- Timeline items injected here -->
                </div>

                <!-- Canvas / Video Area -->
                <div class="md:col-span-2 space-y-4">
                    <div class="bg-black rounded-xl overflow-hidden relative border border-gray-800 shadow-2xl flex items-center justify-center bg-[url('https://placehold.co/1920x1080/000000/000000')] bg-center bg-cover" id="canvas-wrapper">
                        <canvas id="video-canvas"></canvas>
                        
                        <!-- Overlay: Render Button -->
                        <div id="render-overlay" class="absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm z-10">
                            <button onclick="startRendering()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-full font-bold flex items-center gap-3 transform hover:scale-105 transition-all shadow-xl border border-blue-400/30">
                                <i data-lucide="layers" class="w-6 h-6"></i> Start Rendering
                            </button>
                        </div>

                        <!-- Overlay: Processing -->
                        <div id="processing-overlay" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-20">
                            <i data-lucide="loader-2" class="w-12 h-12 text-blue-500 animate-spin mb-4"></i>
                            <h2 class="text-2xl font-bold text-white mb-2" id="process-text">Rendering...</h2>
                            <div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden">
                                <div id="process-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Download Section -->
                    <div id="download-section" class="hidden animate-fade-in">
                        <div class="bg-green-900/20 border border-green-500/30 p-4 rounded-xl flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-green-400">Video Ready!</h3>
                                <p class="text-xs text-gray-400">Your viral video has been generated.</p>
                            </div>
                            <a id="download-link" href="#" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Download
                            </a>
                        </div>
                    </div>
                    
                    <button onclick="setStep(3)" class="text-gray-400 hover:text-white text-sm mt-2">← Back to Script</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Global Loading Modal -->
    <div id="loading-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 text-center max-w-sm w-full mx-4 shadow-2xl">
            <i data-lucide="loader-2" class="w-10 h-10 text-blue-500 animate-spin mx-auto mb-4"></i>
            <h3 class="text-lg font-bold" id="loading-text">Processing...</h3>
            <p class="text-xs text-gray-400 mt-2">Please wait while AI works its magic.</p>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- State ---
        let state = {
            step: 1,
            topic: '',
            aspectRatio: '9:16', // or '16:9'
            duration: '60',
            language: 'English',
            voice: 'Aoede',
            titles: [],
            selectedTitle: '',
            scriptData: [], // { text, image_prompt, imageSrc, audioUrl, audioDuration }
            keys: {
                main: localStorage.getItem('vv_key_main') || '',
                image: localStorage.getItem('vv_key_image') || '',
                voice: localStorage.getItem('vv_key_voice') || ''
            }
        };

        // --- Refs ---
        const els = {
            apiKeyMain: document.getElementById('api-key-main'),
            apiKeyImage: document.getElementById('api-key-image'),
            apiKeyVoice: document.getElementById('api-key-voice'),
            settingsPanel: document.getElementById('settings-panel'),
            stepIndicator: document.getElementById('step-indicator'),
            topicInput: document.getElementById('topic-input'),
            durationSelect: document.getElementById('duration-select'),
            langSelect: document.getElementById('language-select'),
            voiceSelect: document.getElementById('voice-select'),
            loadingModal: document.getElementById('loading-modal'),
            loadingText: document.getElementById('loading-text'),
            canvas: document.getElementById('video-canvas'),
            processOverlay: document.getElementById('processing-overlay'),
            processText: document.getElementById('process-text'),
            processBar: document.getElementById('process-bar'),
            renderOverlay: document.getElementById('render-overlay'),
            downloadSection: document.getElementById('download-section'),
            downloadLink: document.getElementById('download-link')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateStepUI();
            
            // Pre-fill keys
            els.apiKeyMain.value = state.keys.main;
            els.apiKeyImage.value = state.keys.image;
            els.apiKeyVoice.value = state.keys.voice;

            // Check if user has keys, if not show settings
            if(!state.keys.main) {
                toggleSettings();
            }
        });

        // --- Settings Logic ---
        function toggleSettings() {
            els.settingsPanel.classList.toggle('hidden');
        }

        function saveSettings() {
            state.keys.main = els.apiKeyMain.value.trim();
            state.keys.image = els.apiKeyImage.value.trim();
            state.keys.voice = els.apiKeyVoice.value.trim();
            
            localStorage.setItem('vv_key_main', state.keys.main);
            localStorage.setItem('vv_key_image', state.keys.image);
            localStorage.setItem('vv_key_voice', state.keys.voice);
            
            toggleSettings();
            alert("API Keys Saved!");
        }

        function getApiKey(type) {
            if (type === 'image' && state.keys.image) return state.keys.image;
            if (type === 'voice' && state.keys.voice) return state.keys.voice;
            return state.keys.main;
        }

        // --- UI Navigation ---
        function setStep(n) {
            state.step = n;
            updateStepUI();
        }

        function setAspectRatio(ratio) {
            state.aspectRatio = ratio;
            
            // Update UI buttons
            const btn916 = document.getElementById('ratio-9-16');
            const btn169 = document.getElementById('ratio-16-9');
            const icon916 = btn916.querySelector('svg');
            const icon169 = btn169.querySelector('svg');

            if (ratio === '9:16') {
                btn916.className = "cursor-pointer p-4 rounded-xl border-2 border-blue-500 bg-blue-500/10 transition-all flex flex-col items-center gap-2";
                icon916.classList.replace('text-gray-400', 'text-blue-400');
                
                btn169.className = "cursor-pointer p-4 rounded-xl border-2 border-gray-700 bg-gray-800 transition-all flex flex-col items-center gap-2 hover:border-gray-500";
                icon169.classList.replace('text-blue-400', 'text-gray-400');
            } else {
                btn169.className = "cursor-pointer p-4 rounded-xl border-2 border-blue-500 bg-blue-500/10 transition-all flex flex-col items-center gap-2";
                icon169.classList.replace('text-gray-400', 'text-blue-400');
                
                btn916.className = "cursor-pointer p-4 rounded-xl border-2 border-gray-700 bg-gray-800 transition-all flex flex-col items-center gap-2 hover:border-gray-500";
                icon916.classList.replace('text-blue-400', 'text-gray-400');
            }
        }

        function updateStepUI() {
            // Hide all steps
            [1, 2, 3, 4].forEach(i => document.getElementById(`step-${i}`).classList.add('hidden'));
            // Show current
            document.getElementById(`step-${state.step}`).classList.remove('hidden');

            // Render Indicator
            const labels = ['Concept', 'Title', 'Script', 'Result'];
            els.stepIndicator.innerHTML = labels.map((label, idx) => {
                const stepNum = idx + 1;
                const isActive = state.step >= stepNum;
                const isCurrent = state.step === stepNum;
                const colorClass = isActive ? 'text-blue-500' : 'text-gray-500';
                const circleClass = isActive ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-600 bg-gray-800';
                
                return `
                    <div class="flex flex-col items-center ${colorClass}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all ${circleClass}">
                            ${isActive ? '<i data-lucide="check" class="w-4 h-4"></i>' : stepNum}
                        </div>
                        <span class="text-xs mt-1 font-medium">${label}</span>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function showLoading(msg) {
            els.loadingText.innerText = msg;
            els.loadingModal.classList.remove('hidden');
        }

        function hideLoading() {
            els.loadingModal.classList.add('hidden');
        }

        // --- Step 1: Generate Titles ---
        async function generateTitles() {
            const topic = els.topicInput.value;
            if (!topic) return alert("Please enter a topic");
            if (!getApiKey('main')) return alert("Please set API Key in settings");

            state.topic = topic;
            state.duration = els.durationSelect.value;
            state.language = els.langSelect.value;
            state.voice = els.voiceSelect.value;

            showLoading("Thinking of viral titles...");

            const prompt = `You are a YouTube viral expert. Create 5 short, clickbaity, and viral video titles for the topic: "${topic}". 
            Format: ${state.aspectRatio === '9:16' ? 'YouTube Shorts / TikTok Style' : 'YouTube Long Video Style'}.
            Language: ${state.language}.
            Return ONLY the titles separated by a pipe symbol (|). Do not add numbering or extra text.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getApiKey('main')}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                state.titles = text.split('|').map(t => t.trim()).filter(t => t.length > 0);
                
                renderTitles();
                setStep(2);
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                hideLoading();
            }
        }

        function renderTitles() {
            const container = document.getElementById('titles-container');
            container.innerHTML = state.titles.map(t => `
                <button onclick="selectTitle('${t.replace(/'/g, "\\'")}')" class="text-left w-full bg-gray-800 p-4 rounded-xl hover:border-blue-500 border border-gray-700 transition-all hover:bg-gray-750 flex justify-between items-center group">
                    <span class="font-medium group-hover:text-blue-400 transition-colors">${t}</span>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600 group-hover:text-blue-500"></i>
                </button>
            `).join('');
            lucide.createIcons();
        }

        // --- Step 2: Generate Script ---
        async function selectTitle(title) {
            state.selectedTitle = title;
            showLoading("Writing viral script...");
            
            const targetWords = Math.round((parseInt(state.duration) / 60) * 145);
            
            const prompt = `Create a video script for the title: "${title}". 
            Target Duration: ${state.duration} seconds.
            Target Word Count: Approx ${targetWords} words.
            Aspect Ratio: ${state.aspectRatio} (${state.aspectRatio === '9:16' ? 'Vertical, focus on center' : 'Horizontal, cinematic'}).
            Language: ${state.language}.
            Divide the script into scenes naturally based on the flow.
            Return valid JSON array of objects. 
            Format: [{"text": "Voiceover text here", "image_prompt": "Detailed description, ensure visual fits ${state.aspectRatio} aspect ratio"}]
            Clean JSON only, no markdown formatting like \`\`\`json`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getApiKey('main')}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);

                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                state.scriptData = JSON.parse(rawText);
                
                // Initialize default props
                state.scriptData = state.scriptData.map(s => ({
                    ...s,
                    imageSrc: null,
                    audioUrl: null,
                    audioDuration: 3000
                }));

                renderScript();
                setStep(3);
            } catch (e) {
                console.error(e);
                alert("Error generating script: " + e.message);
            } finally {
                hideLoading();
            }
        }

        function renderScript() {
            document.getElementById('preview-ratio').innerText = state.aspectRatio;
            document.getElementById('preview-scenes').innerText = `${state.scriptData.length} Scenes`;
            
            const container = document.getElementById('script-container');
            container.innerHTML = state.scriptData.map((scene, idx) => `
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-gray-500 uppercase">Scene ${idx + 1}</span>
                    </div>
                    <p class="text-gray-200 mb-2 font-medium">${scene.text}</p>
                    <div class="text-xs text-gray-500 italic flex items-center gap-2 border-t border-gray-800 pt-2 mt-2">
                        <i data-lucide="image" class="w-3 h-3"></i> ${scene.image_prompt}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- Step 3: Generate Assets (Image + Audio) ---
        async function generateAssets() {
            // Setup Step 4 UI
            setStep(4);
            els.renderOverlay.classList.add('hidden'); // Hide render button initially
            els.processOverlay.classList.remove('hidden'); // Show progress
            els.processText.innerText = "Generating AI Assets...";
            
            const totalItems = state.scriptData.length * 2;
            let completed = 0;
            
            const updateProgress = () => {
                completed++;
                const pct = (completed / totalItems) * 100;
                els.processBar.style.width = `${pct}%`;
            };

            const processScene = async (scene, index) => {
                // 1. Generate Image
                const ratioKeywords = state.aspectRatio === '9:16' ? "vertical, portrait format, 9:16 aspect ratio, tall image" : "cinematic, wide angle, 16:9 aspect ratio";
                let imageSrc = `https://placehold.co/${state.aspectRatio === '9:16' ? '720x1280' : '1280x720'}/222/FFF?text=Generating...`;

                try {
                    const imgResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${getApiKey('image')}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            instances: [{ prompt: `Photorealistic, 8k, ${ratioKeywords}, ${scene.image_prompt}` }], 
                            parameters: { sampleCount: 1 } 
                        })
                    });
                    const imgData = await imgResponse.json();
                    if (imgData.predictions?.[0]?.bytesBase64Encoded) {
                        imageSrc = `data:image/png;base64,${imgData.predictions[0].bytesBase64Encoded}`;
                    } else {
                        console.warn("Image gen failed, using placeholder", imgData);
                    }
                } catch (e) { console.error("Image Error", e); }
                updateProgress();

                // 2. Generate Audio
                let audioUrl = null;
                let audioDuration = 3000;
                try {
                    const ttsResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${getApiKey('voice')}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: scene.text }] }],
                            generationConfig: { 
                                responseModalities: ["AUDIO"], 
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: state.voice } } } 
                            }
                        })
                    });
                    const ttsData = await ttsResponse.json();
                    const audioBase64 = ttsData.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    
                    if (audioBase64) {
                        audioUrl = pcmToWav(audioBase64);
                        // Approximate duration: (bytes / sampleRate / channels / bitDepth) * 1000
                        const byteLength = (audioBase64.length * 3) / 4; 
                        audioDuration = (byteLength / 48000) * 1000 + 500; // 24kHz -> 48k bytes rate approx
                    }
                } catch (e) { console.error("TTS Error", e); }
                updateProgress();

                // Update State
                state.scriptData[index].imageSrc = imageSrc;
                state.scriptData[index].audioUrl = audioUrl;
                state.scriptData[index].audioDuration = audioDuration;
                
                // Update Timeline UI
                renderTimeline();
            };

            // Run in parallel
            await Promise.all(state.scriptData.map((s, i) => processScene(s, i)));

            els.processOverlay.classList.add('hidden');
            els.renderOverlay.classList.remove('hidden'); // Show render button
            
            // Draw first frame to canvas
            if(state.scriptData[0]?.imageSrc) {
                drawPlaceholder(state.scriptData[0].imageSrc);
            }
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = state.scriptData.map((scene, idx) => `
                <div class="bg-gray-800 p-2 rounded flex gap-3 items-center opacity-90 border border-gray-700">
                    <img src="${scene.imageSrc || 'https://placehold.co/100'}" class="w-12 h-12 object-cover rounded bg-gray-900 border border-gray-600">
                    <div class="min-w-0 flex-1">
                        <div class="text-xs truncate text-gray-300">${scene.text}</div>
                        <div class="text-[10px] text-gray-500 mt-0.5 flex gap-2">
                            ${scene.audioUrl 
                                ? '<span class="text-green-400 flex items-center gap-1"><i data-lucide="music" class="w-3 h-3"></i> Audio Ready</span>' 
                                : '<span class="text-red-400">No Audio</span>'}
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function drawPlaceholder(src) {
            const canvas = els.canvas;
            const ctx = canvas.getContext('2d');
            // Set Size
            canvas.width = state.aspectRatio === '9:16' ? 720 : 1280;
            canvas.height = state.aspectRatio === '9:16' ? 1280 : 720;
            // Handle Wrapper Aspect
            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.style.aspectRatio = state.aspectRatio === '9:16' ? '9/16' : '16/9';

            const img = new Image();
            img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
            img.src = src;
        }

        // --- Step 4: Render Video (Canvas + WebAudio) ---
        async function startRendering() {
            els.renderOverlay.classList.add('hidden');
            els.processOverlay.classList.remove('hidden');
            els.processText.innerText = "Rendering Video...";
            els.downloadSection.classList.add('hidden');

            const canvas = els.canvas;
            const ctx = canvas.getContext('2d');
            
            // Audio setup
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioCtx = new AudioContext();
            const dest = audioCtx.createMediaStreamDestination();
            
            // Silence track to keep recorder alive
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            gain.gain.value = 0;
            osc.connect(gain);
            gain.connect(dest);
            osc.start();

            // Recorder setup
            const canvasStream = canvas.captureStream(30);
            const combinedStream = new MediaStream([
                ...canvasStream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            const mimeType = MediaRecorder.isTypeSupported('video/webm; codecs=vp9') 
                ? 'video/webm; codecs=vp9' 
                : 'video/webm';
            
            const recorder = new MediaRecorder(combinedStream, { mimeType, videoBitsPerSecond: 5000000 });
            const chunks = [];
            
            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                els.processOverlay.classList.add('hidden');
                els.downloadSection.classList.remove('hidden');
                
                els.downloadLink.href = url;
                els.downloadLink.download = `viral_${state.aspectRatio === '9:16' ? 'short' : 'video'}_${Date.now()}.webm`;
                
                osc.stop();
                audioCtx.close();
            };

            recorder.start();

            // Rendering Loop
            let currentImg = new Image();
            
            // Preload first image
            if(state.scriptData[0].imageSrc) {
                currentImg.src = state.scriptData[0].imageSrc;
                await new Promise(r => currentImg.onload = r);
            }

            // Animation Loop variables
            let drawing = true;
            let currentText = "";
            
            function draw() {
                if(!drawing) return;
                
                // Draw Image
                ctx.drawImage(currentImg, 0, 0, canvas.width, canvas.height);

                // Draw Text Overlay
                if(currentText) {
                    const isVertical = state.aspectRatio === '9:16';
                    const boxH = isVertical ? 300 : 150;
                    
                    ctx.fillStyle = 'rgba(0,0,0,0.6)';
                    ctx.fillRect(0, canvas.height - boxH, canvas.width, boxH);
                    
                    ctx.font = `bold ${isVertical ? '48px' : '36px'} Arial`;
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    
                    const words = currentText.split(' ');
                    let line = '';
                    let lines = [];
                    const maxW = canvas.width - 100;

                    for(let n=0; n<words.length; n++) {
                        let testLine = line + words[n] + ' ';
                        let metrics = ctx.measureText(testLine);
                        if(metrics.width > maxW && n > 0) {
                            lines.push(line);
                            line = words[n] + ' ';
                        } else {
                            line = testLine;
                        }
                    }
                    lines.push(line);

                    const lh = isVertical ? 60 : 45;
                    const startY = canvas.height - (boxH/2) - ((lines.length-1)*lh/2) + 20;
                    lines.forEach((l, k) => ctx.fillText(l, canvas.width/2, startY + (k*lh)));
                }

                requestAnimationFrame(draw);
            }
            draw(); // Start Loop

            // Sequencing
            for(let i=0; i<state.scriptData.length; i++) {
                const scene = state.scriptData[i];
                const pct = Math.round((i / state.scriptData.length) * 100);
                els.processBar.style.width = `${pct}%`;
                els.processText.innerText = `Rendering Scene ${i+1}/${state.scriptData.length}`;

                // Update Image
                const img = new Image();
                img.src = scene.imageSrc;
                await new Promise(r => img.onload = r);
                currentImg = img;
                currentText = scene.text;

                // Play Audio
                if(scene.audioUrl) {
                    const resp = await fetch(scene.audioUrl);
                    const buf = await resp.arrayBuffer();
                    const audioBuf = await audioCtx.decodeAudioData(buf);
                    const src = audioCtx.createBufferSource();
                    src.buffer = audioBuf;
                    src.connect(dest);
                    src.start(0);
                    // Wait for audio to finish + small buffer
                    await new Promise(r => setTimeout(r, (audioBuf.duration * 1000) + 200));
                } else {
                    await new Promise(r => setTimeout(r, 3000));
                }
            }

            drawing = false;
            els.processBar.style.width = '100%';
            setTimeout(() => recorder.stop(), 500);
        }

        // --- Helper: PCM to WAV ---
        function pcmToWav(pcmBase64) {
            const binaryString = atob(pcmBase64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            
            const sampleRate = 24000;
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + len, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, len, true);
            
            const wavBytes = new Uint8Array(wavHeader.byteLength + len);
            wavBytes.set(new Uint8Array(wavHeader), 0);
            wavBytes.set(bytes, wavHeader.byteLength);
            
            return URL.createObjectURL(new Blob([wavBytes], { type: 'audio/wav' }));
        }

    </script>
</body>
</html>
