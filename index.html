<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViralVideo Creator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen selection:bg-blue-500 selection:text-white">

    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-2 rounded-lg">
                    <i data-lucide="video" class="w-5 h-5 text-white"></i>
                </div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                    ViralVideo Creator Pro
                </h1>
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-gray-800 rounded-full transition-colors relative">
                <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
                <span id="keyMissingDot" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 md:p-8 relative">

        <!-- Settings Modal (Hidden by default) -->
        <div id="settingsPanel" class="hidden mb-6 bg-gray-800 rounded-xl p-6 border border-gray-700 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="key" class="w-5 h-5 text-yellow-400"></i> API Configuration</h2>
            </div>
            <p class="text-gray-400 mb-4 text-sm bg-yellow-500/10 border border-yellow-500/20 p-3 rounded">
                ⚠️ This tool requires your own <strong>Google Gemini API Key</strong> to work.
            </p>
            <label class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1 block">Your API Key</label>
            <input type="password" id="customApiKey" placeholder="Paste your API Key here (starts with AIza...)" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-sm mb-4 focus:border-blue-500 outline-none text-white">
            <div class="flex justify-end gap-2">
                <button onclick="saveSettings()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold text-sm transition-colors">
                    Save Key
                </button>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="flex justify-between items-center mb-8 px-4">
            <div class="step-item flex flex-col items-center text-blue-500" id="step1-ind">
                <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 bg-blue-500 border-blue-500 text-white font-bold text-sm">1</div>
                <span class="text-xs mt-1">Concept</span>
            </div>
            <div class="step-item flex flex-col items-center text-gray-500" id="step2-ind">
                <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-600 bg-gray-800 font-bold text-sm">2</div>
                <span class="text-xs mt-1">Title</span>
            </div>
            <div class="step-item flex flex-col items-center text-gray-500" id="step3-ind">
                <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-600 bg-gray-800 font-bold text-sm">3</div>
                <span class="text-xs mt-1">Script</span>
            </div>
            <div class="step-item flex flex-col items-center text-gray-500" id="step4-ind">
                <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-600 bg-gray-800 font-bold text-sm">4</div>
                <span class="text-xs mt-1">Render</span>
            </div>
        </div>

        <!-- Views Container -->
        <div id="viewsContainer">

            <!-- View 1: Input -->
            <div id="view-1" class="bg-gray-800 rounded-xl p-8 text-center border border-gray-700">
                <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="wand-2" class="w-8 h-8 text-blue-400"></i>
                </div>
                <h2 class="text-2xl font-bold mb-6">Create Viral Video</h2>
                
                <div class="max-w-xl mx-auto space-y-4 text-left">
                    <!-- Topic -->
                    <div>
                        <label class="text-xs text-gray-400 font-bold ml-1 mb-1 block uppercase tracking-wide">Video Topic</label>
                        <input type="text" id="topicInput" placeholder="e.g. Scariest Places, AI Future..." class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-blue-500 outline-none">
                    </div>

                    <!-- Ratio Selector -->
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="setRatio('9:16')" id="ratio-9-16" class="cursor-pointer p-4 rounded-xl border-2 border-gray-700 bg-gray-800 hover:border-gray-600 transition-all flex flex-col items-center gap-2">
                            <i data-lucide="smartphone" class="w-6 h-6 text-gray-400"></i>
                            <span class="text-sm font-bold">Shorts (9:16)</span>
                        </div>
                        <div onclick="setRatio('16:9')" id="ratio-16-9" class="cursor-pointer p-4 rounded-xl border-2 border-blue-500 bg-blue-500/10 transition-all flex flex-col items-center gap-2">
                            <i data-lucide="monitor" class="w-6 h-6 text-blue-400"></i>
                            <span class="text-sm font-bold">Video (16:9)</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <!-- Duration -->
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Duration</label>
                            <select id="durationSelect" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm outline-none">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <!-- Language -->
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Language</label>
                            <select id="languageSelect" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm outline-none">
                                <option value="English">English</option>
                                <option value="Hindi">Hindi</option>
                                <option value="Urdu">Urdu</option>
                                <option value="Spanish">Spanish</option>
                                <option value="German">German</option>
                            </select>
                        </div>
                        <!-- Voice -->
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Voice</label>
                            <select id="voiceSelect" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-sm outline-none">
                                <option value="Aoede">Female - Soft</option>
                                <option value="Kore">Female - Energetic</option>
                                <option value="Fenrir">Male - Deep</option>
                                <option value="Charon">Male - Narrator</option>
                                <option value="Puck">Male - Casual</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="generateTitles()" id="btnGenerateTitles" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex justify-center gap-2 items-center mt-4 transition-all hover:scale-[1.02]">
                        <i data-lucide="wand-2" class="w-5 h-5"></i> Generate Titles
                    </button>
                </div>
            </div>

            <!-- View 2: Titles -->
            <div id="view-2" class="hidden space-y-4">
                <h2 class="text-xl font-bold">Select Title</h2>
                <div id="titlesList" class="grid gap-3"></div>
                <button onclick="goToStep(1)" class="text-sm text-gray-400 hover:text-white mt-2">← Back</button>
            </div>

            <!-- View 3: Script & Assets -->
            <div id="view-3" class="hidden bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold">Script Preview</h2>
                        <div id="scriptInfo" class="flex items-center gap-2 text-xs text-gray-400 mt-1"></div>
                    </div>
                    <button onclick="generateAssets()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-green-900/50 transition-all hover:scale-105">
                        <i data-lucide="zap" class="w-4 h-4 text-yellow-300 fill-current"></i> Fast Generate
                    </button>
                </div>
                <div id="scriptContainer" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2"></div>
            </div>

            <!-- View 4: Render -->
            <div id="view-4" class="hidden grid md:grid-cols-3 gap-6">
                <!-- Timeline -->
                <div class="md:col-span-1 space-y-3 max-h-[70vh] overflow-y-auto" id="timelineContainer">
                    <h3 class="font-bold text-gray-400 text-xs uppercase">Timeline</h3>
                    <!-- Items injected here -->
                </div>

                <!-- Canvas -->
                <div class="md:col-span-2 space-y-4">
                    <div id="canvasWrapper" class="bg-black rounded-xl overflow-hidden relative border border-gray-800 shadow-2xl flex items-center justify-center mx-auto">
                        <canvas id="videoCanvas" class="w-full h-full object-contain"></canvas>
                        
                        <!-- Overlay: Start Render -->
                        <div id="startRenderOverlay" class="absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <button onclick="renderVideo()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-full font-bold flex items-center gap-3 transform hover:scale-105 transition-all shadow-xl border border-blue-400/30">
                                <i data-lucide="layers" class="w-6 h-6"></i> Render Video
                            </button>
                        </div>

                        <!-- Overlay: Rendering Progress -->
                        <div id="renderingOverlay" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-20">
                            <div class="loader mb-4 border-t-blue-500"></div>
                            <h2 class="text-2xl font-bold text-white mb-2">Rendering Video...</h2>
                            <p class="text-gray-400 mb-6">Combining Scenes & Voice...</p>
                            <div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden">
                                <div id="renderProgressBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="renderProgressText" class="mt-2 text-sm text-blue-400 font-mono">0% Complete</p>
                        </div>
                    </div>
                    
                    <!-- Done State -->
                    <div id="doneState" class="hidden space-y-4 animate-fade-in max-w-lg mx-auto">
                        <div class="bg-green-900/20 border border-green-500/30 p-4 rounded-xl flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-green-400">Video Ready!</h3>
                                <p class="text-xs text-gray-400">File saved successfully.</p>
                            </div>
                            <a id="downloadLink" href="#" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Download
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Global Loading Overlay -->
        <div id="globalLoader" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 text-center max-w-sm w-full mx-4">
                <div class="loader mx-auto mb-4 border-t-blue-500 w-10 h-10 border-4"></div>
                <h3 id="loadingText" class="text-lg font-bold">Processing...</h3>
                <div class="w-full bg-gray-700 rounded-full h-2 mt-4 overflow-hidden">
                    <div id="globalProgressBar" class="bg-blue-500 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="loadingPercent" class="text-xs text-gray-400 mt-2">0%</p>
            </div>
        </div>

    </main>

    <script>
        // --- State ---
        let state = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            topic: '',
            ratio: '16:9',
            duration: '60',
            language: 'English',
            voice: 'Aoede',
            titles: [],
            scriptData: [],
            title: ''
        };

        // --- Init ---
        lucide.createIcons();
        updateDurationOptions(); // Init options
        
        // Load API Key if exists
        if(state.apiKey) {
            document.getElementById('customApiKey').value = state.apiKey;
        } else {
            // Show red dot if missing
            document.getElementById('keyMissingDot').classList.remove('hidden');
        }

        // --- Helper Functions ---
        function toggleSettings() {
            const el = document.getElementById('settingsPanel');
            el.classList.toggle('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('customApiKey').value.trim();
            if(!key) {
                alert("Please enter a valid API Key!");
                return;
            }
            state.apiKey = key;
            localStorage.setItem('gemini_api_key', key);
            document.getElementById('keyMissingDot').classList.add('hidden');
            alert("API Key Saved Successfully!");
            toggleSettings();
        }

        function checkApiKey() {
            if(!state.apiKey) {
                alert("Please set your Gemini API Key in Settings first!");
                toggleSettings();
                return false;
            }
            return true;
        }

        function setRatio(r) {
            state.ratio = r;
            
            // UI Classes
            const activeClass = "cursor-pointer p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 border-blue-500 bg-blue-500/10";
            const inactiveClass = "cursor-pointer p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 border-gray-700 bg-gray-800";
            
            const btnShort = document.getElementById('ratio-9-16');
            const btnLong = document.getElementById('ratio-16-9');
            
            btnShort.className = r === '9:16' ? activeClass : inactiveClass;
            btnLong.className = r === '16:9' ? activeClass : inactiveClass;
            
            // Icon Colors
            const updateIcon = (id, isActive) => {
                const el = document.querySelector(`#${id} svg`) || document.querySelector(`#${id} i`);
                if(el) {
                    if(isActive) {
                        el.classList.add('text-blue-400');
                        el.classList.remove('text-gray-400');
                    } else {
                        el.classList.add('text-gray-400');
                        el.classList.remove('text-blue-400');
                    }
                }
            };

            updateIcon('ratio-9-16', r === '9:16');
            updateIcon('ratio-16-9', r === '16:9');

            updateDurationOptions();
        }

        function updateDurationOptions() {
            const sel = document.getElementById('durationSelect');
            sel.innerHTML = '';
            
            if (state.ratio === '9:16') {
                // Shorts options
                const opts = [
                    { l: '10 Seconds', v: '10' },
                    { l: '20 Seconds', v: '20' },
                    { l: '30 Seconds', v: '30' },
                    { l: '60 Seconds (1 Min)', v: '60' }
                ];
                opts.forEach(o => sel.add(new Option(o.l, o.v)));
                state.duration = '30'; // Default short
                sel.value = '30';
            } else {
                // Long options
                for(let i=1; i<=30; i++) {
                    sel.add(new Option(`${i} Minute${i>1?'s':''}`, i*60));
                }
                state.duration = '60'; // Default long
                sel.value = '60';
            }
        }

        function goToStep(step) {
            for(let i=1; i<=4; i++) document.getElementById(`view-${i}`).classList.add('hidden');
            document.getElementById(`view-${step}`).classList.remove('hidden');
            
            for(let i=1; i<=4; i++) {
                const ind = document.getElementById(`step${i}-ind`);
                const circle = ind.querySelector('div');
                if (i <= step) {
                    ind.className = 'step-item flex flex-col items-center text-blue-500';
                    circle.className = 'w-8 h-8 rounded-full flex items-center justify-center border-2 bg-blue-500 border-blue-500 text-white font-bold text-sm';
                    if (i < step) circle.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i>`;
                    else circle.innerHTML = i;
                } else {
                    ind.className = 'step-item flex flex-col items-center text-gray-500';
                    circle.className = 'w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-600 bg-gray-800 font-bold text-sm';
                    circle.innerHTML = i;
                }
            }
            lucide.createIcons();
        }

        function showLoader(msg, percent = 0) {
            document.getElementById('globalLoader').classList.remove('hidden');
            document.getElementById('loadingText').innerText = msg;
            updateLoaderPercent(percent);
        }

        function updateLoaderPercent(p) {
            document.getElementById('globalProgressBar').style.width = `${p}%`;
            document.getElementById('loadingPercent').innerText = `${Math.round(p)}%`;
        }

        function hideLoader() {
            document.getElementById('globalLoader').classList.add('hidden');
        }

        // --- Logic ---

        async function generateTitles() {
            if(!checkApiKey()) return;
            state.topic = document.getElementById('topicInput').value;
            state.duration = document.getElementById('durationSelect').value;
            state.language = document.getElementById('languageSelect').value;
            state.voice = document.getElementById('voiceSelect').value;

            if(!state.topic) return alert("Please enter a topic");

            showLoader(`Generating ${state.ratio === '9:16' ? 'Shorts' : 'Video'} Titles...`, 10);
            
            try {
                const prompt = `You are a YouTube viral expert. Create 5 short, clickbaity, and viral video titles for the topic: "${state.topic}". 
                Format: ${state.ratio === '9:16' ? 'YouTube Shorts / TikTok Style' : 'YouTube Long Video Style'}.
                Language: ${state.language}.
                Return ONLY the titles separated by a pipe symbol (|). Do not add numbering or extra text.`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                state.titles = text.split('|').map(t => t.trim()).filter(t => t.length > 0);
                
                // Render List
                const list = document.getElementById('titlesList');
                list.innerHTML = '';
                state.titles.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = "text-left bg-gray-800 p-4 rounded-xl hover:border-blue-500 border border-gray-700 transition-colors w-full font-medium";
                    btn.innerText = t;
                    btn.onclick = () => generateScript(t);
                    list.appendChild(btn);
                });

                hideLoader();
                goToStep(2);

            } catch(e) {
                console.error(e);
                alert("Error generating titles. Check your API Key.");
                hideLoader();
            }
        }

        async function generateScript(title) {
            if(!checkApiKey()) return;
            state.title = title;
            const words = Math.round((parseInt(state.duration)/60) * 145);
            
            showLoader(`Writing Script (~${words} words)...`, 20);

            try {
                const prompt = `Create a video script for the title: "${title}". 
                Target Duration: ${state.duration} seconds.
                Target Word Count: Approx ${words} words.
                Aspect Ratio: ${state.ratio} (${state.ratio === '9:16' ? 'Vertical' : 'Horizontal'}).
                Language: ${state.language}.
                Divide the script into scenes naturally based on the flow.
                Return valid JSON array of objects. 
                Format: [{"text": "Voiceover text here", "image_prompt": "Detailed description, ensure visual fits ${state.ratio} aspect ratio"}]`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });

                const data = await res.json();
                const jsonStr = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const script = JSON.parse(jsonStr);
                
                state.scriptData = script.map(s => ({...s, imageSrc: null, audioUrl: null, audioDuration: 3000}));

                // Render Preview
                document.getElementById('scriptInfo').innerHTML = `
                    <span class="bg-gray-700 px-2 py-0.5 rounded text-gray-200">${state.ratio}</span>
                    <span class="bg-gray-700 px-2 py-0.5 rounded text-gray-200">${state.duration}s</span>
                    <span>${state.scriptData.length} Scenes</span>
                `;
                
                const cont = document.getElementById('scriptContainer');
                cont.innerHTML = '';
                state.scriptData.forEach((s, idx) => {
                    cont.innerHTML += `
                        <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold text-gray-500 uppercase">Scene ${idx + 1}</span>
                            </div>
                            <p class="text-gray-200 mb-2">${s.text}</p>
                            <div class="text-xs text-gray-500 italic flex items-center gap-2">
                                <i data-lucide="image" class="w-3 h-3"></i> ${s.image_prompt}
                            </div>
                        </div>
                    `;
                });
                lucide.createIcons();

                hideLoader();
                goToStep(3);

            } catch(e) {
                console.error(e);
                alert("Error generating script");
                hideLoader();
            }
        }

        async function generateAssets() {
            if(!checkApiKey()) return;
            showLoader("Generating Assets (Fast Mode)...", 0);
            
            const total = state.scriptData.length * 2;
            let done = 0;
            const updateP = () => { done++; updateLoaderPercent((done/total)*100); };

            const promises = state.scriptData.map(async (scene, idx) => {
                // 1. Image
                const ratioKey = state.ratio === '9:16' ? "vertical, 9:16, portrait" : "cinematic, 16:9, wide";
                let imgUrl = `https://placehold.co/${state.ratio==='9:16'?'720x1280':'1280x720'}/222/FFF?text=Scene+${idx+1}`;
                
                try {
                    const imgRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${state.apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ instances: [{ prompt: `Photorealistic, 8k, ${ratioKey}, ${scene.image_prompt}` }], parameters: { sampleCount: 1 } })
                    });
                    const imgData = await imgRes.json();
                    if(imgData.predictions?.[0]?.bytesBase64Encoded) {
                        imgUrl = `data:image/png;base64,${imgData.predictions[0].bytesBase64Encoded}`;
                    }
                } catch(e) { console.error(e); }
                updateP();

                // 2. Audio
                let audUrl = null;
                let audDur = 3000;
                try {
                    const audRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${state.apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: scene.text }] }],
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: state.voice } } } }
                        })
                    });
                    const audData = await audRes.json();
                    const b64 = audData.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if(b64) {
                        audUrl = pcmToWav(b64);
                        const byteLen = (b64.length * 3) / 4; 
                        audDur = (byteLen / 48000) * 1000 + 500; // +500ms buffer
                    }
                } catch(e) { console.error(e); }
                updateP();

                return { ...scene, imageSrc: imgUrl, audioUrl: audUrl, audioDuration: audDur };
            });

            state.scriptData = await Promise.all(promises);
            
            // Prepare View 4
            setupRenderView();
            hideLoader();
            goToStep(4);
        }

        function setupRenderView() {
            // Setup Canvas Ratio
            const wrap = document.getElementById('canvasWrapper');
            const canvas = document.getElementById('videoCanvas');
            
            if(state.ratio === '9:16') {
                wrap.style.aspectRatio = '9/16';
                wrap.style.maxHeight = '70vh';
                wrap.style.width = 'auto';
                canvas.width = 720;
                canvas.height = 1280;
            } else {
                wrap.style.aspectRatio = '16/9';
                wrap.style.maxHeight = 'auto';
                wrap.style.width = '100%';
                canvas.width = 1280;
                canvas.height = 720;
            }

            // Render Timeline
            const tl = document.getElementById('timelineContainer');
            tl.innerHTML = `<h3 class="font-bold text-gray-400 text-xs uppercase mb-2">Timeline</h3>`;
            state.scriptData.forEach((s, i) => {
                tl.innerHTML += `
                     <div class="bg-gray-800 p-2 rounded flex gap-3 items-center opacity-70 hover:opacity-100 transition-opacity mb-2">
                       <img src="${s.imageSrc}" class="w-12 h-12 object-cover rounded bg-gray-900" />
                       <div class="min-w-0 flex-1">
                           <div class="text-xs truncate text-gray-300">${s.text}</div>
                           <div class="text-[10px] text-gray-500 mt-0.5 flex gap-2">
                               ${s.audioUrl ? '<span class="text-green-400 flex items-center gap-1"><i data-lucide="music" class="w-3 h-3"></i> Audio OK</span>' : '<span class="text-red-400">No Audio</span>'}
                           </div>
                       </div>
                     </div>
                `;
            });
            lucide.createIcons();
        }

        // --- Render Logic ---

        function pcmToWav(b64) {
            const bin = atob(b64);
            const len = bin.length;
            const bytes = new Uint8Array(len);
            for(let i=0; i<len; i++) bytes[i] = bin.charCodeAt(i);
            
            const buf = new ArrayBuffer(44 + len);
            const view = new DataView(buf);
            
            const writeS = (o, s) => { for(let i=0; i<s.length; i++) view.setUint8(o+i, s.charCodeAt(i)); };
            
            writeS(0, 'RIFF');
            view.setUint32(4, 36+len, true);
            writeS(8, 'WAVE');
            writeS(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, 24000, true); // Rate
            view.setUint32(28, 48000, true); // ByteRate
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeS(36, 'data');
            view.setUint32(40, len, true);
            
            const wavBytes = new Uint8Array(buf);
            wavBytes.set(bytes, 44);
            
            return URL.createObjectURL(new Blob([buf], {type: 'audio/wav'}));
        }

        async function renderVideo() {
            const btnOverlay = document.getElementById('startRenderOverlay');
            const loadOverlay = document.getElementById('renderingOverlay');
            const progress = document.getElementById('renderProgressBar');
            const progressTxt = document.getElementById('renderProgressText');
            const doneState = document.getElementById('doneState');
            
            btnOverlay.classList.add('hidden');
            loadOverlay.classList.remove('hidden');
            doneState.classList.add('hidden');

            // 1. Setup Contexts
            const actx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = actx.createMediaStreamDestination();
            
            // Silent Oscillator (Fix)
            const osc = actx.createOscillator();
            const gain = actx.createGain();
            gain.gain.value = 0;
            osc.connect(gain);
            gain.connect(dest);
            osc.start();

            const canvas = document.getElementById('videoCanvas');
            const ctx = canvas.getContext('2d');
            const stream = canvas.captureStream(30);
            
            const combined = new MediaStream([
                ...stream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            // Recorder
            let mime = 'video/webm; codecs=vp9';
            if(!MediaRecorder.isTypeSupported(mime)) mime = 'video/webm; codecs=vp8'; // Windows Fix
            if(!MediaRecorder.isTypeSupported(mime)) mime = 'video/webm';

            const rec = new MediaRecorder(combined, { mimeType: mime, videoBitsPerSecond: 3000000 });
            const chunks = [];
            
            rec.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            rec.onstop = () => {
                const blob = new Blob(chunks, {type: 'video/webm'});
                const url = URL.createObjectURL(blob);
                
                // Stop UI
                loadOverlay.classList.add('hidden');
                doneState.classList.remove('hidden');
                
                const dlBtn = document.getElementById('downloadLink');
                dlBtn.href = url;
                dlBtn.download = `viral_${state.ratio==='9:16'?'short':'video'}_${Date.now()}.webm`;
                
                osc.stop();
                actx.close();
                dlBtn.click(); // Auto DL
            };

            rec.start(500); // 500ms chunking fix

            // 2. Playback Loop
            let currentImg = new Image();
            // Preload first
            if(state.scriptData.length > 0) {
                currentImg.src = state.scriptData[0].imageSrc;
                await new Promise(r => currentImg.onload = r);
            }

            // Draw Loop
            let isRunning = true;
            let currentSceneIdx = 0;
            
            const draw = () => {
                if(!isRunning) return;
                
                ctx.drawImage(currentImg, 0, 0, canvas.width, canvas.height);
                
                // Text Overlay
                const scene = state.scriptData[currentSceneIdx];
                if(scene) {
                    const isVert = state.ratio === '9:16';
                    const boxH = isVert ? 220 : 140;
                    
                    ctx.fillStyle = 'rgba(0,0,0,0.6)';
                    ctx.fillRect(0, canvas.height - boxH, canvas.width, boxH);
                    
                    ctx.font = isVert ? 'bold 36px Arial' : 'bold 32px Arial';
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    
                    // Simple Wrap
                    const words = scene.text.split(' ');
                    let line = '';
                    let lines = [];
                    const maxW = canvas.width - 60;
                    
                    words.forEach((w, i) => {
                        const test = line + w + ' ';
                        if(ctx.measureText(test).width > maxW && i > 0) {
                            lines.push(line);
                            line = w + ' ';
                        } else line = test;
                    });
                    lines.push(line);
                    
                    const lh = isVert ? 45 : 40;
                    const startY = canvas.height - (boxH/2) - ((lines.length-1)*lh/2) + 15;
                    lines.forEach((l, k) => ctx.fillText(l, canvas.width/2, startY + (k*lh)));
                }

                requestAnimationFrame(draw);
            };
            draw();

            // Sequencer
            for(let i=0; i<state.scriptData.length; i++) {
                currentSceneIdx = i;
                const pct = Math.round((i / state.scriptData.length) * 100);
                progress.style.width = `${pct}%`;
                progressTxt.innerText = `${pct}% Complete`;
                
                const s = state.scriptData[i];
                
                // Preload Next Image
                if(i+1 < state.scriptData.length) {
                    const nextImg = new Image();
                    nextImg.crossOrigin = "anonymous";
                    nextImg.src = state.scriptData[i+1].imageSrc;
                    // Dont await here, just start loading
                }

                // Update Current Image
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = s.imageSrc;
                await new Promise(r => img.onload = r);
                currentImg = img;

                // Play Audio
                if(s.audioUrl) {
                    const ab = await (await fetch(s.audioUrl)).arrayBuffer();
                    const audioBuf = await actx.decodeAudioData(ab);
                    const src = actx.createBufferSource();
                    src.buffer = audioBuf;
                    src.connect(dest);
                    src.start(0);
                    await new Promise(r => setTimeout(r, (audioBuf.duration * 1000) + 100));
                } else {
                    await new Promise(r => setTimeout(r, 3000));
                }
            }

            // Finish
            progress.style.width = `100%`;
            isRunning = false;
            await new Promise(r => setTimeout(r, 1000));
            rec.stop();
        }

    </script>
</body>
</html>
