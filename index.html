<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grow With Haider - AI Studio</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Reliable Icons -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        heading: ['"Outfit"', 'sans-serif']
                    },
                    colors: { 
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #334155; }
        /* Mesh Gradient Background */
        .bg-mesh {
            background-color: #f1f5f9;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.1) 0, transparent 50%);
            background-attachment: fixed;
        }
        
        /* Glassmorphism */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); 
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        .nav-item { transition: all 0.2s; }
        .nav-item.active { background: #fff; color: #0f172a; font-weight: 700; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 3px solid #3b82f6; }
        
        .loader { width: 16px; height: 16px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 0.8s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Smooth Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-mesh font-sans selection:bg-blue-100">

    <!-- HEADER -->
    <header class="glass-dark h-16 flex-shrink-0 z-50 px-6 flex items-center justify-between text-white">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,160H40V56H216V200ZM176,88a48,48,0,0,1-48,48,48,48,0,0,1-48-48,8,8,0,0,1,16,0,32,32,0,0,0,64,0,8,8,0,0,1,16,0Zm-48,80a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h32A8,8,0,0,1,128,168Z"></path></svg>
            </div>
            <div>
                <h1 class="font-heading font-bold text-lg leading-tight tracking-tight">Grow With Haider</h1>
                <div class="flex items-center gap-2 opacity-80">
                    <p class="text-[10px] font-bold uppercase tracking-widest text-blue-200">Pro Video Studio</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div id="headerKeyStatus" class="hidden md:flex items-center gap-2 text-xs font-medium bg-white/10 px-3 py-1.5 rounded-full border border-white/5 backdrop-blur-sm">
                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse" id="headerStatusDot"></span> 
                <span id="headerStatusText">Setup Required</span>
            </div>
            <button onclick="openSettings()" class="p-2.5 rounded-full hover:bg-white/15 transition text-white shadow-sm border border-white/10 flex items-center justify-center" title="API Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Zm88-29.84q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.21,107.21,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.63q-1.48-1.56-3-3t-3.12-2.84l-2.64-23.72a8,8,0,0,0-3.93-6A107.21,107.21,0,0,0,152.84,29.52a8,8,0,0,0-7.06,1.48L127.14,45.92q-2.16-.06-4.32,0L104.18,31a8,8,0,0,0-7.06-1.48A107.21,107.21,0,0,0,70.87,40.4a8,8,0,0,0-3.93,6l-2.64,23.72q-1.56,1.48-3,3t-3.12,2.84L34.46,78.59a8,8,0,0,0-6,3.93A107.21,107.21,0,0,0,17.58,108.77a8,8,0,0,0,1.48,7.06L34,134.47q-.06,2.16,0,4.32L19.06,157.43a8,8,0,0,0-1.48,7.06,107.21,107.21,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.63q1.48,1.56,3,3t3.12,2.84l2.64,23.72a8,8,0,0,0,3.93,6,107.21,107.21,0,0,0,26.25,10.88,8,8,0,0,0,7.06-1.48l18.64-14.92q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3t3.12-2.84l23.72-2.63a8,8,0,0,0,6-3.93,107.21,107.21,0,0,0,10.88-26.25,8,8,0,0,0-1.48-7.06ZM208,136a80,80,0,1,1-80-80A80.09,80.09,0,0,1,208,136Z"></path></svg>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white/80 backdrop-blur-md border-r border-slate-200 flex flex-col flex-shrink-0 z-20 hidden md:flex">
            <div class="p-6 flex-1 overflow-y-auto">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 px-2">Workflow</h3>
                <nav id="navSteps" class="space-y-1.5"></nav>
            </div>
            <div class="p-5 m-4 bg-slate-50 rounded-xl border border-slate-100">
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-xs text-slate-600">
                        <span class="font-medium">Format</span>
                        <span id="statMode" class="font-bold text-slate-900 bg-white px-2 py-0.5 rounded border border-slate-200">Long</span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-slate-600">
                        <span class="font-medium">Duration</span>
                        <span id="statDuration" class="font-bold text-slate-900 bg-white px-2 py-0.5 rounded border border-slate-200">1m</span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-slate-600">
                        <span class="font-medium">API Keys</span>
                        <span id="apiKeyCount" class="font-bold text-slate-900 bg-white px-2 py-0.5 rounded border border-slate-200">0</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN AREA -->
        <main class="flex-1 overflow-y-auto relative p-6 lg:p-10 scroll-smooth">
            <div class="max-w-5xl mx-auto pb-24" id="mainContainer">

                <!-- STEP 1: CONFIG -->
                <div id="step-1" class="step-content fade-in">
                    <div class="mb-8">
                        <span class="text-blue-600 font-bold text-xs tracking-widest uppercase mb-2 block">Phase 01</span>
                        <h2 class="text-4xl font-heading font-extrabold text-slate-900">Project Configuration</h2>
                    </div>
                    
                    <div class="glass-panel p-8 rounded-2xl mb-8">
                        <div class="mb-8">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Video Format</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="vidFormat" value="long" checked onchange="updateFormat()" class="peer sr-only">
                                    <div class="p-5 rounded-xl border-2 border-slate-100 bg-white peer-checked:border-slate-900 peer-checked:bg-slate-900 peer-checked:text-white transition hover:shadow-lg h-full flex items-center gap-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256" class="opacity-50 peer-checked:opacity-100"><path d="M208,48H48A24,24,0,0,0,24,72V184a24,24,0,0,0,24,24H208a24,24,0,0,0,24-24V72A24,24,0,0,0,208,48Zm8,136a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V72a8,8,0,0,1,8-8H208a8,8,0,0,1,8,8Z"></path></svg>
                                        <div>
                                            <span class="font-bold block text-lg">Long Video</span>
                                            <span class="text-xs opacity-70">16:9 Aspect Ratio (YouTube)</span>
                                        </div>
                                    </div>
                                </label>
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="vidFormat" value="shorts" onchange="updateFormat()" class="peer sr-only">
                                    <div class="p-5 rounded-xl border-2 border-slate-100 bg-white peer-checked:border-slate-900 peer-checked:bg-slate-900 peer-checked:text-white transition hover:shadow-lg h-full flex items-center gap-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256" class="opacity-50 peer-checked:opacity-100"><path d="M176,24H80A24,24,0,0,0,56,48V208a24,24,0,0,0,24,24h96a24,24,0,0,0,24-24V48A24,24,0,0,0,176,24Zm8,184a8,8,0,0,1-8,8H80a8,8,0,0,1-8-8V48a8,8,0,0,1,8-8h96a8,8,0,0,1,8,8Z"></path></svg>
                                        <div>
                                            <span class="font-bold block text-lg">Shorts / Reels</span>
                                            <span class="text-xs opacity-70">9:16 Aspect Ratio (Vertical)</span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Video Topic</label>
                                <textarea id="ideaInput" rows="2" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-200 text-lg font-medium focus:ring-2 focus:ring-blue-600 focus:border-transparent transition outline-none resize-none shadow-inner" placeholder="e.g. The future of AI in Pakistan..."></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Duration</label>
                                    <div class="relative">
                                        <select id="durationSelect" class="w-full p-3 pl-4 rounded-xl bg-white border border-slate-200 font-medium text-slate-700 cursor-pointer outline-none focus:ring-2 focus:ring-blue-600 appearance-none shadow-sm"></select>
                                        <i class="ph-caret-down absolute right-4 top-3.5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Tone</label>
                                    <input type="text" id="toneInput" class="w-full p-3 rounded-xl bg-white border border-slate-200 font-medium text-slate-700 outline-none focus:ring-2 focus:ring-blue-600 shadow-sm" placeholder="Motivational, Educational, Funny...">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="generateTitles()" id="btnGenTitles" class="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold shadow-xl shadow-slate-900/20 hover:scale-[1.02] transition-all transform flex items-center gap-3 text-lg">
                        <i class="ph-sparkle-fill text-yellow-400 text-xl"></i> 
                        Generate Concepts
                    </button>
                    
                    <div id="titleResults" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4 hidden"></div>
                </div>

                <!-- STEP 2: OUTLINE -->
                <div id="step-2" class="step-content hidden fade-in">
                    <div class="mb-8"><h2 class="text-3xl font-heading font-bold text-slate-800">Video Structure</h2></div>
                    <div class="bg-white border-l-4 border-blue-600 shadow-sm rounded-r-xl p-6 mb-8 flex items-start gap-4">
                        <div class="p-3 bg-blue-50 rounded-lg text-blue-600"><i class="ph-lightbulb-fill text-2xl"></i></div>
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase mb-1">Selected Concept</p>
                            <h3 id="displayTitle" class="text-xl font-bold text-slate-800 leading-tight"></h3>
                        </div>
                    </div>
                    <button onclick="generateOutlines()" id="btnGenOutlines" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition flex items-center gap-2">
                        <i class="ph-list-dashes"></i> Generate Outlines
                    </button>
                    <div id="outlineResults" class="mt-8 space-y-4 hidden"></div>
                </div>

                <!-- STEP 3: SCRIPT -->
                <div id="step-3" class="step-content hidden fade-in">
                    <div class="flex justify-between items-end mb-6">
                        <h2 class="text-3xl font-heading font-bold text-slate-800">Script Editor</h2>
                        <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-100 flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-400 uppercase">Length:</span>
                            <span class="text-lg font-bold text-blue-600" id="scriptTargetCount">0 words</span>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-1 mb-6 shadow-lg">
                        <div class="p-3 border-b border-slate-100 bg-slate-50/80 rounded-t-2xl flex justify-between items-center backdrop-blur-sm">
                            <div class="flex gap-1.5 ml-2">
                                <div class="w-2.5 h-2.5 rounded-full bg-red-400"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-green-400"></div>
                            </div>
                            <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-md border border-slate-200">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Lang:</label>
                                <select id="scriptLanguage" class="text-xs font-bold text-slate-700 bg-transparent border-none cursor-pointer outline-none">
                                    <option value="English">English</option>
                                    <option value="Roman Urdu">Roman Urdu</option>
                                    <option value="Hindi">Hindi</option>
                                    <option value="Urdu">Urdu</option>
                                </select>
                            </div>
                        </div>
                        <textarea id="finalScriptArea" rows="16" class="w-full p-6 bg-white/60 rounded-b-2xl border-none text-slate-700 text-lg leading-loose font-medium outline-none resize-none" placeholder="AI will write your script here..."></textarea>
                    </div>
                    <div class="flex flex-wrap gap-4 items-center">
                        <button onclick="generateFullScript()" id="btnGenScript" class="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition flex items-center gap-2"><i class="ph-magic-wand"></i> Write Script</button>
                        <button onclick="goToStep(4)" id="btnProceedAudio" class="hidden ml-auto bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 transition flex items-center gap-2 transform hover:translate-x-1">Next: Audio <i class="ph-arrow-right-bold"></i></button>
                    </div>
                </div>

                <!-- STEP 4: AUDIO -->
                <div id="step-4" class="step-content hidden fade-in">
                    <div class="mb-10 text-center">
                        <span class="text-blue-600 font-bold text-xs tracking-widest uppercase mb-2 block">Audio Synthesis</span>
                        <h2 class="text-3xl font-heading font-bold text-slate-800">Voiceover Studio</h2>
                    </div>
                    <div class="max-w-xl mx-auto glass-panel p-10 rounded-[2rem] text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                        
                        <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-8 text-slate-800 shadow-inner border border-slate-100">
                            <i class="ph-microphone-stage-duotone text-4xl text-blue-600"></i>
                        </div>

                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 block">Select AI Voice</label>
                        <div class="relative mb-8">
                            <select id="voiceSelect" class="w-full p-4 rounded-xl bg-white border border-slate-200 font-bold text-slate-700 text-center cursor-pointer outline-none appearance-none hover:border-blue-400 transition shadow-sm"></select>
                            <i class="ph-caret-down absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                        </div>
                        
                        <button onclick="generateSingleAudio()" id="btnGenAudio" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-slate-800 transition transform hover:-translate-y-1 flex justify-center items-center gap-3 text-lg">
                            <i class="ph-waves"></i> Synthesize Audio
                        </button>
                        
                        <div id="audioResult" class="mt-8 hidden">
                            <div class="bg-slate-900 p-4 rounded-xl shadow-inner mb-6 border border-white/10">
                                <audio id="mainAudioPlayer" controls class="w-full h-10 block" style="filter: invert(1) brightness(0.9)"></audio>
                            </div>
                            <button onclick="goToStep(5)" class="bg-emerald-500 text-white px-10 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-600 transition flex items-center gap-2 mx-auto">Proceed to Visuals <i class="ph-arrow-right-bold"></i></button>
                        </div>
                    </div>
                </div>

                <!-- STEP 5: VISUALS -->
                <div id="step-5" class="step-content hidden fade-in">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
                        <div>
                            <span class="text-purple-600 font-bold text-xs tracking-widest uppercase mb-1 block">Image Generation</span>
                            <h2 class="text-3xl font-heading font-bold text-slate-800">Visual Assets</h2>
                        </div>
                        <div class="flex gap-6 bg-white px-6 py-3 rounded-xl shadow-sm border border-slate-100">
                            <div class="text-right">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Scenes</span>
                                <div id="visualCount" class="text-xl font-bold text-slate-800">0</div>
                            </div>
                            <div class="w-px bg-slate-200"></div>
                            <div class="text-right">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Audio Len</span>
                                <div id="visualAudioDur" class="text-xl font-bold text-slate-800">0s</div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl mb-8 border-l-4 border-purple-500">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Art Style</label>
                                <input id="visualStyle" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200" value="Cinematic, 8k, Photorealistic, Dramatic Lighting">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Aspect Ratio</label>
                                <select id="aspectRatio" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 cursor-not-allowed opacity-70 bg-slate-100" disabled>
                                    <option value="16:9">16:9 (Long Video)</option>
                                    <option value="9:16">9:16 (Shorts/Reels)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mb-8">
                        <button onclick="generatePrompts()" id="btnGenPrompts" class="flex-1 bg-white border border-slate-200 text-slate-700 px-6 py-4 rounded-xl font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2 hover:shadow-md">
                            <span class="w-6 h-6 rounded-full bg-slate-200 text-xs flex items-center justify-center">1</span> Generate Prompts
                        </button>
                        <button onclick="generateImages()" id="btnGenImages" class="flex-1 bg-slate-900 text-white px-6 py-4 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-800 transition shadow-lg flex items-center justify-center gap-2" disabled>
                            <span class="w-6 h-6 rounded-full bg-white/20 text-xs flex items-center justify-center">2</span> Start Rendering
                        </button>
                    </div>

                    <div id="promptsArea" class="hidden mb-6 bg-white border border-slate-200 rounded-2xl p-4 h-40 overflow-y-auto text-xs text-slate-600 font-mono shadow-inner" id="promptsList"></div>
                    
                    <div id="imageProgress" class="hidden mb-8">
                        <div class="flex justify-between text-xs font-bold text-slate-500 mb-2"><span>Rendering Scenes...</span><span id="imageProgressText">0%</span></div>
                        <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden"><div id="imageProgressBar" class="bg-gradient-to-r from-blue-600 to-purple-600 h-full rounded-full transition-all duration-300" style="width: 0%"></div></div>
                    </div>
                    
                    <div id="imageGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-10"></div>
                    
                    <div id="proceedToCompileContainer" class="hidden text-center">
                        <button onclick="goToStep(6)" class="bg-emerald-500 text-white px-12 py-4 rounded-xl font-bold hover:bg-emerald-600 transition shadow-xl shadow-emerald-500/20 transform hover:scale-105 flex items-center gap-2 mx-auto">
                            Finalize Project <i class="ph-check-circle-fill"></i>
                        </button>
                    </div>
                </div>

                <!-- STEP 6: COMPILE -->
                <div id="step-6" class="step-content hidden fade-in">
                    <div class="mb-10 text-center">
                        <span class="text-slate-400 font-bold text-xs uppercase tracking-widest mb-2 block">Final Phase</span>
                        <h2 class="text-4xl font-heading font-bold text-slate-900">Render Production</h2>
                    </div>
                    
                    <div class="glass-dark p-10 rounded-[2.5rem] shadow-2xl text-center mb-8 relative overflow-hidden max-w-3xl mx-auto border border-white/10 bg-slate-900">
                        <!-- Glow effects -->
                        <div class="absolute top-[-20%] left-[-10%] w-64 h-64 bg-blue-500/20 rounded-full blur-3xl pointer-events-none"></div>
                        <div class="absolute bottom-[-20%] right-[-10%] w-64 h-64 bg-purple-500/20 rounded-full blur-3xl pointer-events-none"></div>

                        <div class="relative z-10">
                            <div class="flex justify-center gap-16 mb-12 pb-8 border-b border-white/10">
                                <div><div class="text-5xl font-bold text-blue-400 font-heading" id="compileImgCount">0</div><div class="text-[10px] uppercase font-bold text-slate-400 tracking-widest mt-2">Frames</div></div>
                                <div><div class="text-5xl font-bold text-purple-400 font-heading" id="compileAudioDur">0s</div><div class="text-[10px] uppercase font-bold text-slate-400 tracking-widest mt-2">Audio</div></div>
                            </div>
                            
                            <button onclick="renderVideo()" id="btnRender" class="group bg-white text-slate-900 hover:bg-slate-100 px-12 py-6 rounded-2xl font-black shadow-2xl transition transform hover:scale-105 flex items-center gap-4 mx-auto text-xl">
                                <i class="ph-play-circle-fill text-4xl text-blue-600 group-hover:scale-110 transition"></i> 
                                RENDER VIDEO
                            </button>

                            <canvas id="renderCanvas" class="hidden mx-auto mt-10 rounded-lg shadow-2xl bg-black border border-white/10 max-w-full ring-4 ring-white/5" style="max-height: 400px;"></canvas>
                            
                            <div id="renderProgress" class="hidden mt-10 max-w-md mx-auto text-left">
                                <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase"><span>Processing...</span><span>Encoding</span></div>
                                <div class="w-full bg-slate-800 rounded-full h-1.5"><div id="renderBar" class="bg-emerald-500 h-full rounded-full transition-all shadow-[0_0_15px_rgba(16,185,129,0.6)]" style="width: 0%"></div></div>
                            </div>
                            
                            <div id="downloadContainer" class="hidden mt-10">
                                <button onclick="downloadVideo()" class="bg-emerald-500 text-white px-10 py-4 rounded-2xl font-bold shadow-lg hover:bg-emerald-600 transition flex items-center gap-3 mx-auto text-lg">
                                    <i class="ph-download-simple-bold"></i> Download Video
                                </button>
                                <a id="downloadLink" class="hidden"></a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- API MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-50 hidden flex items-center justify-center fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 m-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-slate-800 via-slate-600 to-slate-800"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-heading font-bold text-slate-800 flex items-center gap-2"><i class="ph-key-fill text-slate-400"></i> API Keys</h3>
                <button type="button" onclick="closeSettings()" class="text-slate-400 hover:text-slate-600 transition p-1 hover:bg-slate-100 rounded-full"><i class="ph-x-bold text-xl"></i></button>
            </div>
            
            <div class="mb-6">
                <div id="keyStatusMsg" class="mb-4 text-sm font-medium bg-slate-50 p-4 rounded-xl border border-slate-100 flex items-center gap-3">
                    <i class="ph-circle-notch animate-spin text-slate-400"></i> Loading...
                </div>
                
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Add More Keys</label>
                <textarea id="userApiKeys" rows="4" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-200 font-mono text-xs text-slate-600 focus:ring-2 focus:ring-slate-800 outline-none resize-none placeholder-slate-400" placeholder="Paste new API keys here (one per line).&#10;They will be added to your existing list."></textarea>
                <p class="text-[10px] text-slate-400 mt-2 flex items-center gap-1"><i class="ph-shield-check-fill"></i> Keys are stored securely in your browser (LocalStorage).</p>
            </div>
            
            <div class="flex gap-3">
                <button type="button" onclick="clearKeys()" class="bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-xl font-bold hover:bg-red-100 transition" title="Delete All Keys"><i class="ph-trash-bold"></i></button>
                <div class="flex-1"></div>
                <button type="button" onclick="closeSettings()" class="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition">Cancel</button>
                <button type="button" onclick="saveSettings()" class="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg flex items-center gap-2">Save & Add <i class="ph-plus-bold"></i></button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 right-8 bg-slate-900 text-white shadow-2xl rounded-xl px-6 py-4 hidden z-50 flex items-center gap-4 border border-white/10 transform transition-all translate-y-20">
        <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400"><i class="ph-check-circle-fill text-xl"></i></div>
        <p id="toastMsg" class="text-sm font-medium pr-2"></p>
    </div>

    <!-- APP LOGIC (No Module - 100% Safe) -->
    <script>
        // --- GLOBAL STATE ---
        const state = {
            currentStep: 1, idea: "", duration: 60, tone: "", format: 'long',
            titles: [], selectedTitle: "", outlines: [], selectedOutline: null,
            fullScript: "", scriptLanguage: "English", prompts: [],
            generatedImages: [], audioBlob: null, audioDuration: 0,
            selectedVoice: "Fenrir", id: Date.now()
        };
        
        let apiKeys = [];
        const steps = [
            {id:1,label:'Configuration',icon:'ph-sliders'},
            {id:2,label:'Structure',icon:'ph-list-dashes'},
            {id:3,label:'Scripting',icon:'ph-text-aa'},
            {id:4,label:'Voiceover',icon:'ph-microphone'},
            {id:5,label:'Visuals',icon:'ph-image-square'},
            {id:6,label:'Export',icon:'ph-export'}
        ];
        const voices = ["Fenrir","Kore","Zephyr","Puck","Charon","Aoede","Leda","Orus"];

        // --- INITIALIZATION ---
        window.onload = function() {
            console.log("App Initializing...");
            loadSettings();
            initUI();
            renderNav();
            updateFormat(); // Initial state
        };

        function initUI() {
            document.getElementById('voiceSelect').innerHTML = voices.map(v=>`<option value="${v}">${v} (AI Model)</option>`).join('');
        }

        // --- SETTINGS & KEYS ---
        function loadSettings() {
            const saved = localStorage.getItem('gemini_api_keys');
            if(saved) {
                apiKeys = JSON.parse(saved);
                updateKeyStatusUI(apiKeys.length);
            } else {
                updateKeyStatusUI(0);
                setTimeout(() => openSettings(), 800); // Prompt user
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            const statusDiv = document.getElementById('keyStatusMsg');
            const inputArea = document.getElementById('userApiKeys');
            
            if (apiKeys.length > 0) {
                statusDiv.innerHTML = `<span class="text-emerald-600 flex items-center gap-2"><i class="ph-lock-key-fill text-lg"></i> <b>${apiKeys.length} Keys</b> Active & Hidden.</span>`;
                statusDiv.className = "mb-4 text-sm font-medium bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex items-center gap-3";
                inputArea.value = "";
                inputArea.placeholder = "Paste MORE keys here to ADD to your list...";
            } else {
                statusDiv.innerHTML = `<span class="text-amber-600 flex items-center gap-2"><i class="ph-warning-circle-fill text-lg"></i> No Keys Found. Please add keys.</span>`;
                statusDiv.className = "mb-4 text-sm font-medium bg-amber-50 p-4 rounded-xl border border-amber-100 flex items-center gap-3";
                inputArea.value = "";
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            const raw = document.getElementById('userApiKeys').value;
            if(raw.trim().length === 0) {
                if(apiKeys.length > 0) closeSettings();
                else showToast("Please enter a key!");
                return;
            }

            const newKeys = raw.split(/[\n,\s]+/).map(k => k.trim()).filter(k => k.length > 10);
            
            if(newKeys.length > 0) {
                const combined = [...new Set([...apiKeys, ...newKeys])];
                localStorage.setItem('gemini_api_keys', JSON.stringify(combined));
                apiKeys = combined;
                updateKeyStatusUI(combined.length);
                showToast(`${newKeys.length} Keys Added! Total: ${combined.length}`);
                closeSettings();
            } else {
                showToast("Invalid Key Format");
            }
        }

        function clearKeys() {
            if(confirm("Delete ALL keys? This cannot be undone.")) {
                localStorage.removeItem('gemini_api_keys');
                apiKeys = [];
                updateKeyStatusUI(0);
                openSettings();
                showToast("All keys deleted.");
            }
        }

        function updateKeyStatusUI(count) {
            const hText = document.getElementById('headerStatusText');
            const hDot = document.getElementById('headerStatusDot');
            const sCount = document.getElementById('apiKeyCount');

            if(count > 0) {
                hText.innerText = `${count} Keys Ready`;
                hDot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]";
                hDot.classList.remove('animate-pulse');
                sCount.innerText = count;
                sCount.className = "font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100";
            } else {
                hText.innerText = "No Keys";
                hDot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                sCount.innerText = "0";
                sCount.className = "font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded border border-red-100";
            }
        }

        function getRandomKey() {
            if(apiKeys.length === 0) return "";
            return apiKeys[Math.floor(Math.random() * apiKeys.length)];
        }

        // --- CORE LOGIC ---
        function updateFormat() {
            const format = document.querySelector('input[name="vidFormat"]:checked').value;
            state.format = format;
            document.getElementById('statMode').innerText = format === 'shorts' ? 'Shorts' : 'Long';
            
            const sel = document.getElementById('durationSelect');
            sel.innerHTML = "";
            
            if(format === 'shorts') {
                [10, 15, 20, 30, 45, 60].forEach(s => sel.add(new Option(`${s} Seconds`, s)));
                document.getElementById('aspectRatio').value = "9:16";
            } else {
                for(let i=1; i<=15; i++) sel.add(new Option(`${i} Minute${i>1?'s':''}`, i*60));
                document.getElementById('aspectRatio').value = "16:9";
            }
            
            // Trigger change manually to update state
            sel.onchange = function() {
                state.duration = parseInt(this.value);
                document.getElementById('statDuration').innerText = state.duration < 60 ? `${state.duration}s` : `${state.duration/60}m`;
            };
            sel.onchange();
        }

        // Navigation
        function renderNav() {
            document.getElementById('navSteps').innerHTML = steps.map(s => 
                `<button onclick="goToStep(${s.id})" id="nav-${s.id}" class="nav-item w-full flex items-center gap-3 p-3 rounded-xl text-xs font-medium text-slate-500 hover:bg-white mb-1 text-left transition-all">
                    <i class="${s.icon} text-lg"></i> ${s.label}
                </button>`).join('');
            highlightStep(state.currentStep);
        }

        function highlightStep(id) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const el = document.getElementById(`nav-${id}`);
            if(el) el.classList.add('active');
        }

        function goToStep(step) {
            if(step > 1 && !state.selectedTitle && step > state.currentStep) return showToast("Please complete this step first!");
            
            // Animation Transition
            const current = document.querySelector('.step-content:not(.hidden)');
            if(current) {
                current.style.opacity = 0;
                setTimeout(() => {
                    current.classList.add('hidden');
                    const next = document.getElementById(`step-${step}`);
                    next.classList.remove('hidden');
                    void next.offsetWidth; // trigger reflow
                    next.style.opacity = 1;
                    next.classList.add('fade-in');
                }, 200);
            } else {
                const next = document.getElementById(`step-${step}`);
                next.classList.remove('hidden');
            }

            state.currentStep = step;
            highlightStep(step);
            
            // Dynamic Updates
            if(step===2) document.getElementById('displayTitle').innerText = state.selectedTitle || "Untitled";
            if(step===3) document.getElementById('scriptTargetCount').innerText = `~${Math.ceil(state.duration/60 * 140)} words`;
            if(step===5) {
                const dur = state.audioDuration || state.duration;
                document.getElementById('visualCount').innerText = Math.ceil(dur/5);
                document.getElementById('visualAudioDur').innerText = dur.toFixed(0)+'s';
                document.getElementById('aspectRatio').value = state.format === 'shorts' ? '9:16' : '16:9';
            }
            if(step===6) {
                document.getElementById('compileImgCount').innerText = state.generatedImages.length;
                document.getElementById('compileAudioDur').innerText = (state.audioDuration||0).toFixed(0)+'s';
            }
        }

        // --- API FUNCTIONS ---
        async function callGemini(prompt) {
            const key = getRandomKey();
            if(!key) { openSettings(); throw new Error("No Key"); }
            
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                if(!resp.ok) throw new Error("API Limit");
                const data = await resp.json();
                return data.candidates[0].content.parts[0].text.trim();
            } catch(e) { showToast("API Error. Trying another key..."); throw e; }
        }

        async function callTTS(text, voice) {
            const key = getRandomKey();
            if(!key) throw new Error("No Key");
            
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    contents:[{parts:[{text}]}], 
                    generationConfig:{responseModalities:["AUDIO"], speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:voice}}}}
                })
            });
            if(!resp.ok) throw new Error("TTS Error");
            const data = await resp.json();
            return data.candidates[0].content.parts[0].inlineData.data;
        }

        async function callImagen(prompt, ratio) {
            const key = getRandomKey();
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${key}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({instances:[{prompt}], parameters:{sampleCount:1, aspectRatio:ratio}})
            });
            if(!resp.ok) throw new Error("Img Error");
            const d = await resp.json();
            return d.predictions[0].bytesBase64Encoded;
        }

        // --- ACTION HANDLERS ---
        async function generateTitles() {
            state.idea = document.getElementById('ideaInput').value;
            if(!state.idea) return showToast("Enter a topic first!");
            
            toggleBtn('btnGenTitles', true);
            const durText = state.format === 'shorts' ? `${state.duration} seconds` : `${state.duration/60} minutes`;
            
            try {
                const res = await callGemini(`Generate 4 viral YouTube ${state.format} titles for "${state.idea}". Duration: ${durText}. Tone: ${document.getElementById('toneInput').value}. Separated by pipes (|).`);
                state.titles = res.split('|').map(t=>t.trim());
                document.getElementById('titleResults').innerHTML = state.titles.map(t=>`<div onclick="selectTitle('${t.replace(/'/g,"\\'")}')" class="p-4 bg-white border border-slate-100 rounded-xl hover:border-blue-500 hover:shadow-md cursor-pointer font-bold text-slate-700 transition">${t}</div>`).join('');
                document.getElementById('titleResults').classList.remove('hidden');
            } catch(e) {}
            toggleBtn('btnGenTitles', false);
        }

        function selectTitle(t) { state.selectedTitle = t; goToStep(2); }

        async function generateOutlines() {
            toggleBtn('btnGenOutlines', true);
            try {
                const res = await callGemini(`Create 3 structural outlines for: "${state.selectedTitle}". Separate with "###". Concise.`);
                state.outlines = res.split('###').map(o=>o.trim()).filter(o=>o.length>10);
                document.getElementById('outlineResults').innerHTML = state.outlines.map((o,i)=>`<div onclick="selectOutline(${i})" class="p-5 bg-white border border-slate-100 rounded-xl hover:border-blue-500 cursor-pointer whitespace-pre-wrap text-sm text-slate-600 hover:shadow-md transition">${o}</div>`).join('');
                document.getElementById('outlineResults').classList.remove('hidden');
            } catch(e){}
            toggleBtn('btnGenOutlines', false);
        }

        function selectOutline(i) { state.selectedOutline = state.outlines[i]; goToStep(3); }

        async function generateFullScript() {
            toggleBtn('btnGenScript', true);
            try {
                const res = await callGemini(`Write a ${state.format==='shorts' ? state.duration+' sec' : state.duration/60+' min'} script for "${state.selectedTitle}". Outline: ${state.selectedOutline}. Lang: ${document.getElementById('scriptLanguage').value}. IMPORTANT: Return ONLY spoken text.`);
                state.fullScript = res; 
                document.getElementById('finalScriptArea').value = res;
                document.getElementById('btnProceedAudio').classList.remove('hidden');
            } catch(e){}
            toggleBtn('btnGenScript', false);
        }

        // Audio
        async function generateSingleAudio() {
            if(!state.fullScript) return showToast("No Script!");
            toggleBtn('btnGenAudio', true);
            
            try {
                // Chunking
                const chunks = splitText(state.fullScript, 800); 
                
                const ac = new (window.AudioContext||window.webkitAudioContext)();
                if (ac.state === 'suspended') await ac.resume();

                const bufs = [];
                
                for(const c of chunks) {
                    // Call API
                    const b64 = await callTTS(c, document.getElementById('voiceSelect').value);
                    
                    // Decode Base64
                    const bin = atob(b64);
                    const len = bin.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
                    
                    // Convert PCM16 to AudioBuffer directly (assuming 24kHz mono)
                    // Create Int16 view of the byte buffer
                    const int16 = new Int16Array(bytes.buffer);
                    const audioBuf = ac.createBuffer(1, int16.length, 24000);
                    const chan = audioBuf.getChannelData(0);
                    
                    // Convert Int16 (-32768 to 32767) to Float32 (-1.0 to 1.0)
                    for(let i=0; i<int16.length; i++) {
                        chan[i] = int16[i] / 32768.0;
                    }
                    
                    bufs.push(audioBuf);
                }
                
                // Merge
                const totalLen = bufs.reduce((acc, buf) => acc + buf.length, 0);
                const merged = ac.createBuffer(1, totalLen, 24000);
                const channelData = merged.getChannelData(0);
                
                let offset = 0;
                for(const buf of bufs) {
                    channelData.set(buf.getChannelData(0), offset);
                    offset += buf.length;
                }
                
                // Render
                state.audioBlob = bufferToWave(merged, totalLen);
                state.audioDuration = merged.duration;
                document.getElementById('mainAudioPlayer').src = URL.createObjectURL(state.audioBlob);
                document.getElementById('audioResult').classList.remove('hidden');

            } catch(e) {
                console.log(e);
                showToast("Audio Error: " + e.message);
            }
            toggleBtn('btnGenAudio', false);
        }

        // Visuals
        async function generatePrompts() {
            if(state.audioDuration<1) return showToast("Audio missing");
            toggleBtn('btnGenPrompts', true);
            const count = Math.ceil(state.audioDuration/5);
            try {
                const res = await callGemini(`Script: "${state.fullScript.substring(0,2000)}...". Generate exactly ${count} visual prompts (5s each). Style: ${document.getElementById('visualStyle').value}. Return prompts separated by "|||".`);
                state.prompts = res.split('|||').map(p=>p.trim()).filter(p=>p.length>5).slice(0, count);
                document.getElementById('promptsList').innerHTML = state.prompts.map((p,i)=>`<div class="border-b border-slate-100 pb-2 mb-2"><span class="font-bold text-purple-600">Scene ${i+1}:</span> ${p}</div>`).join('');
                document.getElementById('promptsArea').classList.remove('hidden');
                document.getElementById('btnGenImages').disabled=false;
            } catch(e){}
            toggleBtn('btnGenPrompts', false);
        }

        async function generateImages() {
            const grid = document.getElementById('imageGrid'); grid.innerHTML=''; state.generatedImages=[];
            document.getElementById('imageProgress').classList.remove('hidden');
            toggleBtn('btnGenImages', true);
            
            for(let i=0; i<state.prompts.length; i++) {
                const p = state.prompts[i];
                document.getElementById('imageProgressBar').style.width = `${Math.round((i/state.prompts.length)*100)}%`;
                document.getElementById('imageProgressText').innerText = `${Math.round((i/state.prompts.length)*100)}%`;
                try {
                    const b64 = await callImagen(p, document.getElementById('aspectRatio').value);
                    const url = `data:image/png;base64,${b64}`;
                    state.generatedImages.push({id:i, url:url});
                    grid.insertAdjacentHTML('beforeend', `<div class="aspect-video bg-slate-100 rounded-xl overflow-hidden shadow border border-slate-200"><img src="${url}" class="w-full h-full object-cover"></div>`);
                } catch(e) {
                    grid.insertAdjacentHTML('beforeend', `<div class="aspect-video bg-red-50 rounded-xl flex items-center justify-center text-red-400 text-xs border border-red-100">Error</div>`);
                }
            }
            document.getElementById('proceedToCompileContainer').classList.remove('hidden');
            toggleBtn('btnGenImages', false);
        }

        // Render
        async function renderVideo() {
            if(!state.audioBlob || state.generatedImages.length===0) return showToast("Assets Missing!");
            const btn = document.getElementById('btnRender'); btn.disabled=true; btn.innerHTML='<div class="loader"></div> Processing...';
            document.getElementById('renderProgress').classList.remove('hidden');
            
            const cvs = document.getElementById('renderCanvas'); cvs.classList.remove('hidden');
            const ratio = document.getElementById('aspectRatio').value;
            if(ratio==='9:16') { cvs.width=720; cvs.height=1280; } else { cvs.width=1280; cvs.height=720; }
            const ctx = cvs.getContext('2d');

            const ac = new (window.AudioContext||window.webkitAudioContext)();
            const ab = await state.audioBlob.arrayBuffer();
            const buf = await ac.decodeAudioData(ab);
            const dest = ac.createMediaStreamDestination();
            const src = ac.createBufferSource(); src.buffer=buf; src.connect(dest);
            const gain = ac.createGain(); gain.gain.value=0; src.connect(gain); gain.connect(ac.destination);

            const stream = cvs.captureStream(30);
            const combined = new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            const mime = MediaRecorder.isTypeSupported("video/webm;codecs=vp9") ? "video/webm;codecs=vp9" : "video/webm";
            const rec = new MediaRecorder(combined, {mimeType:mime, videoBitsPerSecond:5000000});
            const chunks=[];
            
            rec.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
            rec.onstop = () => {
                const blob = new Blob(chunks, {type:mime});
                const url = URL.createObjectURL(blob);
                const a = document.getElementById('downloadLink'); a.href=url; 
                a.download = `HaiderStudio_${Date.now()}.webm`;
                document.getElementById('downloadContainer').classList.remove('hidden');
                btn.disabled=false; btn.innerHTML='RENDER VIDEO';
                src.disconnect();
            };

            const imgs=[];
            for(const d of state.generatedImages) {
                await new Promise(r=>{ const i=new Image(); i.onload=()=>r(imgs.push(i)); i.onerror=r; i.src=d.url; });
            }

            rec.start(); src.start();
            const startT = ac.currentTime;
            const imgDur = buf.duration / imgs.length;

            function draw() {
                const elap = ac.currentTime - startT;
                if(elap >= buf.duration) { rec.stop(); return; }
                document.getElementById('renderBar').style.width = `${(elap/buf.duration)*100}%`;
                let idx = Math.floor(elap/imgDur); if(idx>=imgs.length) idx=imgs.length-1;
                const img = imgs[idx];
                ctx.fillStyle="#000"; ctx.fillRect(0,0,cvs.width,cvs.height);
                if(img) {
                    const zoom = 1 + (elap % imgDur) * 0.05; 
                    const scale = Math.max(cvs.width/img.width, cvs.height/img.height) * zoom;
                    const x = (cvs.width/2) - (img.width/2)*scale;
                    const y = (cvs.height/2) - (img.height/2)*scale;
                    ctx.drawImage(img, x, y, img.width*scale, img.height*scale);
                }
                requestAnimationFrame(draw);
            }
            draw();
        }

        function downloadVideo() { document.getElementById('downloadLink').click(); }

        // Utils
        function splitText(t,s){const c=[];while(t.length>s){let i=t.lastIndexOf(' ',s);if(i===-1)i=s;c.push(t.substring(0,i));t=t.substring(i).trim()}c.push(t);return c}
        function toggleBtn(id,l){const b=document.getElementById(id);if(l){b.dataset.o=b.innerHTML;b.innerHTML='<div class="loader"></div>';b.disabled=true}else{b.innerHTML=b.dataset.o;b.disabled=false}}
        function showToast(m){const t=document.getElementById('toast');document.getElementById('toastMsg').innerText=m;t.classList.remove('hidden','translate-y-20');setTimeout(()=>{t.classList.add('translate-y-20');setTimeout(()=>t.classList.add('hidden'),300)},3000)}
        function bufferToWave(ab, len) {
            const numOfChan = ab.numberOfChannels, length = len * numOfChan * 2 + 44, buffer = new ArrayBuffer(length), view = new DataView(buffer), channels = [], sampleRate = ab.sampleRate, offset = 0, pos = 0;
            for(let i=0; i<ab.numberOfChannels; i++) channels.push(ab.getChannelData(i));
            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157); setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan); setUint32(sampleRate); setUint32(sampleRate * 2 * numOfChan); setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 8);
            for(let i=0; i<ab.length; i++) for(let ch=0; ch<numOfChan; ch++) { let sample = Math.max(-1, Math.min(1, channels[ch][i])); sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF; view.setInt16(pos, sample, true); pos += 2; }
            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; } function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
            return new Blob([buffer], { type: "audio/wav" });
        }
    </script>
</body>
</html>
